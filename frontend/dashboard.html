<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoTrack - Carbon Footprint Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #3bb273;
        --secondary: #f5f5f5;
        --accent: #2c8e68;
        --text: #333333;
        --light-text: #666666;
        --card-bg: #ffffff;
        --badge-locked: #dddddd;
      }

      body {
        background-color: var(--secondary);
        color: var(--text);
        padding-bottom: 70px;
      }

      .container {
        max-width: 100%;
        padding: 0 16px;
      }

      /* Header */
      header {
        background-color: var(--primary);
        color: white;
        padding: 16px;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .logo {
        font-weight: bold;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Navigation */
      nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: white;
        display: flex;
        justify-content: space-around;
        padding: 12px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--light-text);
        font-size: 0.8rem;
      }

      .nav-item.active {
        color: var(--primary);
      }

      .nav-item i {
        font-size: 1.2rem;
        margin-bottom: 4px;
      }

      /* Cards */
      .card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 20px;
        margin: 16px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .card-title {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 16px;
        color: var(--accent);
      }

      /* Buttons */
      .btn {
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 14px 24px;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        display: block;
        width: 100%;
        text-align: center;
        transition: all 0.2s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn:hover {
        background-color: var(--accent);
        transform: translateY(-2px);
      }

      .btn:active {
        transform: translateY(0);
      }

      /* Dashboard */
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .stat-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary);
        margin: 8px 0;
      }

      .stat-label {
        font-size: 0.9rem;
        color: var(--light-text);
      }

      .streak {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }

      /* Charts */
      .chart-container {
        height: 250px;
        margin: 20px 0;
        position: relative;
      }

      .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        font-size: 0.8rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }

      .legend-color.primary {
        background: var(--primary);
      }

      .legend-color.secondary {
        background: #27ae60;
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent);
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--light-text);
        padding: 5px;
      }

      .close-btn:hover {
        color: var(--text);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .activity-categories {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        margin: 20px 0;
      }

      .activity-category {
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .activity-category:hover {
        border-color: var(--primary);
        background: rgba(59, 178, 115, 0.05);
      }

      .activity-category.selected {
        border-color: var(--primary);
        background: rgba(59, 178, 115, 0.1);
      }

      .activity-category i {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 8px;
      }

      .activity-category h4 {
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .activity-category p {
        font-size: 0.8rem;
        color: var(--light-text);
      }

      .carbon-impact {
        background: var(--secondary);
        padding: 16px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
      }

      .carbon-impact h4 {
        color: var(--accent);
        margin-bottom: 8px;
      }

      .carbon-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary);
      }

      .carbon-unit {
        font-size: 1rem;
        color: var(--light-text);
      }

      .suggestions {
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        padding: 16px;
        border-radius: 12px;
        margin: 20px 0;
        border-left: 4px solid var(--primary);
      }

      .suggestions h4 {
        color: var(--accent);
        margin-bottom: 8px;
        font-size: 1.1rem;
      }

      .suggestions p {
        color: var(--text);
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .alternatives h5 {
        color: var(--accent);
        margin-bottom: 8px;
        font-size: 0.9rem;
      }

      .alternatives-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .alternative-tag {
        background: var(--primary);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .recent-activities {
        margin-top: 20px;
      }

      .activity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e0e0e0;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
      }

      .activity-details h5 {
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .activity-details p {
        font-size: 0.8rem;
        color: var(--light-text);
      }

      .activity-carbon {
        text-align: right;
      }

      .activity-carbon .value {
        font-weight: bold;
        color: var(--primary);
      }

      .activity-carbon .unit {
        font-size: 0.8rem;
        color: var(--light-text);
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--light-text);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        color: var(--light-text);
      }

      /* Eco Suggestions */
      .suggestion-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid #e0e0e0;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item i {
        font-size: 1.5rem;
        color: var(--primary);
        margin-top: 4px;
      }

      .suggestion-item h4 {
        font-size: 1rem;
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 4px;
      }

      .suggestion-item p {
        font-size: 0.9rem;
        color: var(--light-text);
        line-height: 1.4;
      }

      /* Utility */
      .hidden {
        display: none;
      }

      .page {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .page.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Logout button styles */
      header .fa-user-circle {
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      header .fa-user-circle:hover {
        transform: scale(1.1);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="logo">
        <i class="fas fa-leaf"></i>
        <span>EcoTrack</span>
      </div>
      <i class="fas fa-user-circle" style="font-size: 1.5rem"></i>
    </header>

    <div class="container">
      <!-- Dashboard Page -->
      <div class="page active" id="dashboard">
        <div class="card">
          <div class="card-title">Weekly Carbon Footprint</div>
          <div class="chart-container">
            <canvas id="weekly-chart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color primary"></div>
              <span>Carbon Produced</span>
            </div>
            <div class="legend-item">
              <div class="legend-color secondary"></div>
              <span>Carbon Saved</span>
            </div>
          </div>
        </div>

        <div class="stat-card" style="margin-bottom: 15px">
          <div class="stat-label" style="text-align: left">
            AI-Powered Daily Suggestion
          </div>
          <div
            class="stat-value"
            style="text-align: left; font-size: 1.5rem"
            id="daily-suggestion"
          >
            Log an activity for analysis.
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Carbon Produced</div>
            <div class="stat-value" id="weekly-carbon">0 lbs</div>
            <div class="stat-label">this week</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Carbon Saved</div>
            <div class="stat-value" id="carbon-saved">0 lbs</div>
            <div class="stat-label">this week</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Current Streak</div>
            <div class="stat-value" id="current-streak">0 days</div>
            <div class="streak">
              <i class="fas fa-fire" style="color: #ff9900"></i>
              <span id="streak-message">Start logging!</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Activities Logged</div>
            <div class="stat-value" id="activities-count">0</div>
            <div class="stat-label">this week</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Quick Actions</div>
          <button class="btn" id="log-action-btn">
            <i class="fas fa-plus"></i> Log New Action
          </button>
        </div>

        <div class="card">
          <div class="card-title">Recent Activities</div>
          <div id="recent-activities">
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <p>
                No activities logged yet. Start by logging your first
                eco-friendly action!
              </p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Eco Suggestions</div>
          <div id="eco-suggestions"></div>
        </div>
      </div>
    </div>

    <!-- Logging Modal -->
    <div class="modal" id="logging-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Log Eco-Friendly Action</h3>
          <button class="close-btn" id="close-modal">&times;</button>
        </div>

        <form id="activity-form">
          <div class="form-group">
            <label>Activity Category</label>
            <div class="activity-categories">
              <div class="activity-category" data-category="transport">
                <i class="fas fa-bus"></i>
                <h4>Transportation</h4>
                <p>Walking, cycling, public transport</p>
              </div>
              <div class="activity-category" data-category="energy">
                <i class="fas fa-bolt"></i>
                <h4>Energy</h4>
                <p>Electricity, heating, cooling</p>
              </div>
              <div class="activity-category" data-category="food">
                <i class="fas fa-utensils"></i>
                <h4>Food</h4>
                <p>Diet choices, food waste</p>
              </div>
              <div class="activity-category" data-category="waste">
                <i class="fas fa-recycle"></i>
                <h4>Waste</h4>
                <p>Recycling, composting</p>
              </div>
              <div class="activity-category" data-category="shopping">
                <i class="fas fa-shopping-bag"></i>
                <h4>Shopping</h4>
                <p>Fashion, purchases</p>
              </div>
              <div class="activity-category" data-category="lifestyle">
                <i class="fas fa-home"></i>
                <h4>Lifestyle</h4>
                <p>Daily habits</p>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="activity-type">Activity Type</label>
            <select id="activity-type" name="activityType" required>
              <option value="">Select an activity...</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="activity-amount">Amount</label>
              <input
                type="number"
                id="activity-amount"
                name="amount"
                step="0.1"
                min="0"
                required
              />
            </div>
            <div class="form-group">
              <label for="activity-unit">Unit</label>
              <select id="activity-unit" name="unit" required>
                <option value="">Select unit...</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="activity-duration">Duration (hours)</label>
            <input
              type="number"
              id="activity-duration"
              name="duration"
              step="0.1"
              min="0"
              value="1"
            />
          </div>

          <div class="form-group">
            <label for="activity-notes">Notes (optional)</label>
            <textarea
              id="activity-notes"
              name="notes"
              rows="3"
              placeholder="Add any additional details..."
            ></textarea>
          </div>

          <div class="carbon-impact" id="carbon-impact" style="display: none">
            <h4>Estimated Carbon Impact</h4>
            <div class="carbon-value" id="carbon-value">0</div>
            <div class="carbon-unit">lbs CO₂</div>
          </div>

          <div class="suggestions" id="suggestions" style="display: none">
            <h4>Suggestion</h4>
            <p id="suggestion-text"></p>
            <div class="alternatives" id="alternatives">
              <h5>Try these alternatives:</h5>
              <div id="alternatives-list"></div>
            </div>
          </div>

          <button type="submit" class="btn" id="save-activity">
            <i class="fas fa-save"></i> Save Activity
          </button>
        </form>
      </div>
    </div>

    <!-- Logout Modal -->
    <div class="modal" id="logout-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Logout</h3>
          <button class="close-btn" id="close-logout-modal">&times;</button>
        </div>
        <div class="form-group">
          <p>Are you sure you want to logout?</p>
        </div>
        <div style="display: flex; gap: 12px">
          <button
            class="btn"
            id="confirm-logout"
            style="background-color: #e74c3c"
          >
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
          <button
            class="btn"
            id="cancel-logout"
            style="background-color: var(--light-text)"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav>
      <a href="dashboard.html" class="nav-item active">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
      </a>
      <a href="leaderboard.html" class="nav-item">
        <i class="fas fa-ranking-star"></i>
        <span>Leaderboard</span>
      </a>
      <a href="badges.html" class="nav-item">
        <i class="fas fa-trophy"></i>
        <span>Badges</span>
      </a>
      <a href="volunteer.html" class="nav-item">
        <i class="fas fa-hands-helping"></i>
        <span>Volunteer</span>
      </a>
      <a href="map.html" class="nav-item">
        <i class="fas fa-map-marked-alt"></i>
        <span>Map</span>
      </a>
      <a href="resources.html" class="nav-item">
        <i class="fas fa-book"></i>
        <span>Resources</span>
      </a>
    </nav>
    <script>
      const BASE_URL = "https://ecoapi-8zkj.onrender.com";
      let weeklyChart = null;

      class EcoTrackData {
        constructor() {
          this.activities = [];
          this.settings = {};
          this.badges = [];
          this.name = "";
          this.email = "";
          this.ecoSuggestions = [];
          this.init();
        }

        async init() {
          await this.loadUserData();
          this.updateDashboard();
        }

        async loadEcoSuggestions() {
          console.log(this.ecoSuggestions, this.ecoSuggestions.length);
          if (this.ecoSuggestions.length > 0) {
            console.log(this.ecoSuggestions.length);
            this.ecoSuggestions.forEach((item) => {
              let aOrH4 =
                item.website !== ""
                  ? `<a href='${item.website}' target="_blank" style="text-decoration: none;">${item.name}</a>`
                  : item.name;
              const card = document.createElement("div");
              card.classList.add("suggestion-item");
              card.innerHTML = `
                <i class="fas ${item.recommend_icon}"></i>
              <div>
                <h4>${aOrH4}</h4>
                <p>
                  ${item.description}
                </p>
                <p>
                  <strong>Address:</strong> ${item.address}
                </p>
                </div>
                `;
              document.getElementById("eco-suggestions").appendChild(card);
            });
          } else {
            const response = await fetch(
              `${BASE_URL}/api/v1/ecoRecommendations`,
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (response.ok) {
              const data = await response.json();
              console.log(data);
              if (data.response) {
                this.ecoSuggestions = JSON.parse(data.response);
                return this.loadEcoSuggestions();
              }
            }
          }
        }

        async dailySuggestion() {
          try {
            const response = await fetch(`${BASE_URL}/api/v1/dailySuggestion`, {
              method: "GET",
              credentials: "include",
            });

            if (response.ok) {
              const data = await response.json();
              if (data.success && data.message) {
                document.getElementById("daily-suggestion").textContent =
                  data.message;
              } else {
                document.getElementById("daily-suggestion").textContent =
                  "An error occured";
              }
            } else {
              document.getElementById("daily-suggestion").textContent =
                "An error occured";
            }
          } catch (err) {
            console.error(err);
          }
        }

        async loadUserData() {
          try {
            const response = await fetch(`${BASE_URL}/api/auth/verify`, {
              method: "GET",
              credentials: "include",
            });

            if (response.ok) {
              const userData = await response.json();

              localStorage.setItem("userId", userData.user.userId);

              this.name = userData.user.name || "";
              this.email = userData.user.email || "";
              this.activities = userData.user.activities || [];
              this.settings = userData.user.settings || {};
              this.badges = userData.user.badges || [];
              this.ecoSuggestions = userData.user.ecoRecommendations
                ? JSON.parse(userData.user.ecoRecommendations)
                : [];
              this.updateDashboard();
              this.loadEcoSuggestions();
              if (this.activities.length > 0) {
                document.getElementById("daily-suggestion").textContent =
                  "Loading..";
                this.dailySuggestion();
              } else {
                document.getElementById("daily-suggestion").textContent =
                  "Log an activity for analysis.";
              }
            } else {
              console.log("not ok");
              //window.location.href = '/index.html';
            }
          } catch (error) {
            //window.location.href = '/index.html';
            console.error("Error loading user data:", error);
          }
        }

        async saveActivities() {
          this.updateDashboard();
        }

        async addActivity(activity) {
          const newActivity = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            ...activity,
          };

          try {
            const response = await fetch(`${BASE_URL}/api/v1/addLog`, {
              method: "POST",
              credentials: "include",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(activity),
            });

            if (response.ok) {
              // yay
            } else {
            }
          } catch (err) {
            console.error(err);
          }

          this.activities.unshift(newActivity);
          await this.saveActivities();
          return newActivity;
        }

        getWeeklyActivities() {
          const oneWeekAgo = new Date();
          oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
          return this.activities.filter(
            (activity) => new Date(activity.timestamp) >= oneWeekAgo
          );
        }

        getDailyActivities(date) {
          const targetDate = new Date(date);
          return this.activities.filter((activity) => {
            const activityDate = new Date(activity.timestamp);
            return activityDate.toDateString() === targetDate.toDateString();
          });
        }

        calculateWeeklyCarbon() {
          const weeklyActivities = this.getWeeklyActivities();
          return weeklyActivities.reduce((total, activity) => {
            return (
              total + (activity.carbonSaved > 0 ? 0 : activity.carbonImpact)
            );
          }, 0);
        }

        calculateWeeklySavings() {
          const weeklyActivities = this.getWeeklyActivities();
          return weeklyActivities.reduce((total, activity) => {
            return total + (activity.carbonSaved || 0);
          }, 0);
        }

        calculateStreak() {
          const today = new Date();
          let streak = 0;

          for (let i = 0; i < 365; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - i);
            const dayActivities = this.getDailyActivities(checkDate);

            if (dayActivities.length > 0) {
              streak++;
            } else {
              break;
            }
          }

          return streak;
        }

        updateDashboard() {
          this.updateWeeklyChart();
          this.updateStats();
          this.updateRecentActivities();

          if (this.activities.length == 1) {
            this.dailySuggestion();
          }

          if (this.name) {
            const userNameElement = document.getElementById("user-name");
            if (userNameElement) {
              userNameElement.textContent = this.name;
            }
          }
        }

        updateWeeklyChart() {
          const ctx = document.getElementById("weekly-chart").getContext("2d");

          if (weeklyChart) {
            weeklyChart.destroy();
          }

          const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
          const today = new Date();

          const carbonData = new Array(7).fill(0);
          const savedData = new Array(7).fill(0);

          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const dayIndex = date.getDay();
            const dayActivities = this.getDailyActivities(date);
            const dayCarbon = dayActivities.reduce(
              (total, activity) =>
                total + (activity.carbonSaved > 0 ? 0 : activity.carbonImpact),
              0
            );
            const daySaved = dayActivities.reduce(
              (total, activity) => total + (activity.carbonSaved || 0),
              0
            );
            carbonData[dayIndex] += dayCarbon * 2.20462;
            savedData[dayIndex] += daySaved * 2.20462;
          }

          weeklyChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: days,
              datasets: [
                {
                  label: "Carbon Produced",
                  data: carbonData,
                  backgroundColor: "#3BB273",
                  borderColor: "#2C8E68",
                  borderWidth: 1,
                  borderRadius: 8,
                  borderSkipped: false,
                },
                {
                  label: "Carbon Saved",
                  data: savedData,
                  backgroundColor: "#27AE60",
                  borderColor: "#2ECC71",
                  borderWidth: 1,
                  borderRadius: 8,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(0,0,0,0.05)" },
                  ticks: {
                    callback: function (value) {
                      return value + " lbs";
                    },
                  },
                },
                x: { grid: { display: false } },
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return (
                        context.dataset.label +
                        ": " +
                        context.parsed.y.toFixed(1) +
                        " lbs"
                      );
                    },
                  },
                },
              },
            },
          });
        }

        updateStats() {
          const weeklyCarbon = this.calculateWeeklyCarbon();
          const weeklySavings = this.calculateWeeklySavings();
          const streak = this.calculateStreak();
          const weeklyActivities = this.getWeeklyActivities();

          const weeklyCarbonElement = document.getElementById("weekly-carbon");
          const carbonSavedElement = document.getElementById("carbon-saved");
          const currentStreakElement =
            document.getElementById("current-streak");
          const activitiesCountElement =
            document.getElementById("activities-count");

          if (weeklyCarbonElement)
            weeklyCarbonElement.textContent = `${(
              weeklyCarbon * 2.20462
            ).toFixed(1)} lbs`;
          if (carbonSavedElement)
            carbonSavedElement.textContent = `${(
              weeklySavings * 2.20462
            ).toFixed(1)} lbs`;
          if (currentStreakElement)
            currentStreakElement.textContent = `${streak} days`;
          if (activitiesCountElement)
            activitiesCountElement.textContent = weeklyActivities.length;

          const streakMessage = document.getElementById("streak-message");
          if (streakMessage) {
            if (streak === 0) {
              streakMessage.textContent = "Start logging!";
            } else if (streak < 3) {
              streakMessage.textContent = "Good start!";
            } else if (streak < 7) {
              streakMessage.textContent = "Keep it up!";
            } else if (streak < 30) {
              streakMessage.textContent = "Excellent!";
            } else {
              streakMessage.textContent = "Amazing!";
            }
          }
        }

        updateRecentActivities() {
          const container = document.getElementById("recent-activities");
          if (!container) return;

          const recentActivities = this.activities.slice(0, 5);
          console.log(this.activities);
          console.log(recentActivities);

          if (recentActivities.length === 0) {
            container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>No activities logged yet. Start by logging your first eco-friendly action!</p>
                    </div>
                `;
            return;
          }

          container.innerHTML = recentActivities
            .map(
              (activity) => `
                <div class="activity-item">
                    <div class="activity-info">
                        <div class="activity-icon">
                            <i class="fas ${this.getActivityIcon(
                              activity.category
                            )}"></i>
                        </div>
                        <div class="activity-details">
                            <h5>${activity.activityType}</h5>
                            <p>${new Date(
                              activity.timestamp
                            ).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="activity-carbon">
                        <div class="value">${(
                          activity.carbonImpact * 2.20462 || 0
                        ).toFixed(1)}</div>
                        <div class="unit">lbs CO₂</div>
                    </div>
                </div>
            `
            )
            .join("");
        }

        getActivityIcon(category) {
          const icons = {
            transport: "fa-bus",
            energy: "fa-bolt",
            food: "fa-utensils",
            waste: "fa-recycle",
            shopping: "fa-shopping-bag",
            lifestyle: "fa-home",
          };
          return icons[category] || "fa-leaf";
        }
      }

      const activityData = {
        transport: {
          Walking: {
            unit: "miles",
            factor: 0,
            icon: "fa-walking",
            alternatives: ["Cycling", "Public Transport"],
            suggestion: "Great choice! Walking is carbon-neutral and healthy.",
          },
          Cycling: {
            unit: "miles",
            factor: 0,
            icon: "fa-bicycle",
            alternatives: ["Walking", "Electric Bike"],
            suggestion:
              "Excellent! Cycling is zero-emission and great exercise.",
          },
          "Public Transport": {
            unit: "miles",
            factor: 0.31,
            icon: "fa-bus",
            alternatives: ["Walking", "Cycling", "Carpooling"],
            suggestion: "Good choice! Much better than driving alone.",
          },
          "Electric Car": {
            unit: "miles",
            factor: 0.11,
            icon: "fa-car",
            alternatives: ["Public Transport", "Cycling", "Walking"],
            suggestion:
              "Better than gas cars, but consider public transport for short trips.",
          },
          "Gas Car": {
            unit: "miles",
            factor: 0.42,
            icon: "fa-car",
            alternatives: [
              "Public Transport",
              "Cycling",
              "Walking",
              "Carpooling",
            ],
            suggestion:
              "Consider carpooling, public transport, or cycling for shorter trips.",
          },
          Carpooling: {
            unit: "miles",
            factor: 0.18,
            icon: "fa-users",
            alternatives: ["Public Transport", "Cycling"],
            suggestion: "Great way to reduce emissions per person!",
          },
          "Flight (Short)": {
            unit: "miles",
            factor: 0.55,
            icon: "fa-plane",
            alternatives: ["Train", "Bus", "Video Conference"],
            suggestion:
              "Consider train travel or video calls for shorter distances.",
          },
          "Flight (Long)": {
            unit: "miles",
            factor: 0.62,
            icon: "fa-plane",
            alternatives: ["Train", "Offset Carbon"],
            suggestion:
              "Consider carbon offsetting or train travel when possible.",
          },
        },
        energy: {
          "LED Light Bulb": {
            unit: "hours",
            factor: 0.0001,
            icon: "fa-lightbulb",
            alternatives: ["Natural Light", "Solar Lighting"],
            suggestion: "LEDs are 75% more efficient than incandescent bulbs!",
          },
          "Solar Panel": {
            unit: "kWh",
            factor: -0.88,
            icon: "fa-solar-panel",
            alternatives: ["Wind Energy", "Geothermal"],
            suggestion: "Excellent! Solar panels can power your home cleanly.",
          },
          "Wind Energy": {
            unit: "kWh",
            factor: -0.022,
            icon: "fa-wind",
            alternatives: ["Solar Panel", "Hydroelectric"],
            suggestion: "Great renewable energy choice!",
          },
          "Electricity (Grid)": {
            unit: "kWh",
            factor: 0.88,
            icon: "fa-bolt",
            alternatives: ["Solar Panel", "Wind Energy", "Energy Efficiency"],
            suggestion:
              "Consider renewable energy or energy-efficient appliances.",
          },
          "Heating (Gas)": {
            unit: "hours",
            factor: 0.44,
            icon: "fa-fire",
            alternatives: ["Heat Pump", "Solar Heating", "Better Insulation"],
            suggestion:
              "Improve insulation and consider heat pumps for efficiency.",
          },
          "Air Conditioning": {
            unit: "hours",
            factor: 0.66,
            icon: "fa-snowflake",
            alternatives: ["Fans", "Natural Ventilation", "Shade"],
            suggestion: "Use fans and natural ventilation when possible.",
          },
        },
        food: {
          "Plant-based Meal": {
            unit: "meals",
            factor: -1.1,
            icon: "fa-leaf",
            alternatives: ["Local Produce", "Organic Food"],
            suggestion:
              "Excellent! Plant-based meals have much lower carbon footprint.",
          },
          "Meat Meal": {
            unit: "meals",
            factor: 5.5,
            icon: "fa-drumstick-bite",
            alternatives: [
              "Plant-based Meal",
              "Local Meat",
              "Smaller Portions",
            ],
            suggestion:
              "Consider reducing meat consumption or choosing local, organic options.",
          },
          "Dairy Product": {
            unit: "servings",
            factor: 1.76,
            icon: "fa-cheese",
            alternatives: ["Plant-based Alternatives", "Local Dairy"],
            suggestion:
              "Try plant-based alternatives or choose local, organic dairy.",
          },
          "Local Produce": {
            unit: "lbs",
            factor: -0.44,
            icon: "fa-apple-alt",
            alternatives: ["Grow Your Own", "Farmers Market"],
            suggestion:
              "Perfect! Local produce reduces transportation emissions.",
          },
          "Food Waste Reduction": {
            unit: "lbs",
            factor: -2.64,
            icon: "fa-trash",
            alternatives: ["Composting", "Meal Planning"],
            suggestion:
              "Great! Food waste reduction is one of the most impactful actions.",
          },
          "Organic Food": {
            unit: "lbs",
            factor: -0.22,
            icon: "fa-seedling",
            alternatives: ["Local Produce", "Grow Your Own"],
            suggestion: "Organic farming practices are better for soil health.",
          },
        },
        waste: {
          Recycling: {
            unit: "lbs",
            factor: -1.1,
            icon: "fa-recycle",
            alternatives: ["Reduce", "Reuse", "Compost"],
            suggestion:
              "Good start! Remember: reduce and reuse before recycling.",
          },
          Composting: {
            unit: "lbs",
            factor: -0.66,
            icon: "fa-seedling",
            alternatives: ["Vermicomposting", "Community Compost"],
            suggestion:
              "Excellent! Composting reduces methane emissions from landfills.",
          },
          "Plastic Reduction": {
            unit: "items",
            factor: -0.22,
            icon: "fa-ban",
            alternatives: [
              "Reusable Bags",
              "Glass Containers",
              "Bulk Shopping",
            ],
            suggestion: "Every plastic item avoided makes a difference!",
          },
          "Paper Reduction": {
            unit: "lbs",
            factor: -1.76,
            icon: "fa-file",
            alternatives: ["Digital Documents", "Recycled Paper", "Both Sides"],
            suggestion: "Go digital when possible, use both sides of paper.",
          },
        },
        shopping: {
          "Fast Fashion": {
            unit: "items",
            factor: 2.64,
            icon: "fa-tshirt",
            alternatives: ["Second-hand", "Sustainable Brands", "Rent"],
            suggestion:
              "Consider second-hand shopping or sustainable fashion brands.",
          },
          "Second-hand Shopping": {
            unit: "items",
            factor: -0.66,
            icon: "fa-hand-holding",
            alternatives: ["Repair", "Swap", "Borrow"],
            suggestion: "Perfect! Second-hand shopping extends product life.",
          },
          "Online Shopping": {
            unit: "orders",
            factor: 0.88,
            icon: "fa-shopping-cart",
            alternatives: ["Local Shopping", "Bulk Orders", "Pickup Points"],
            suggestion: "Try local shopping or consolidate online orders.",
          },
          "Local Shopping": {
            unit: "trips",
            factor: -0.22,
            icon: "fa-store",
            alternatives: ["Walking to Store", "Bulk Shopping"],
            suggestion:
              "Great! Supporting local businesses and reducing shipping.",
          },
          "Bulk Shopping": {
            unit: "trips",
            factor: -0.44,
            icon: "fa-boxes",
            alternatives: ["Local Shopping", "Zero-waste Stores"],
            suggestion: "Excellent! Bulk shopping reduces packaging waste.",
          },
        },
        lifestyle: {
          "Water Conservation": {
            unit: "gallons",
            factor: -0.0022,
            icon: "fa-tint",
            alternatives: ["Rainwater Collection", "Low-flow Fixtures"],
            suggestion:
              "Every drop counts! Consider rain barrels and low-flow fixtures.",
          },
          "Digital Detox": {
            unit: "hours",
            factor: -0.11,
            icon: "fa-mobile-alt",
            alternatives: ["Outdoor Activities", "Reading", "Crafts"],
            suggestion:
              "Reducing screen time saves energy and improves well-being.",
          },
          "Minimalist Living": {
            unit: "items",
            factor: -0.44,
            icon: "fa-home",
            alternatives: ["Decluttering", "Multi-purpose Items"],
            suggestion: "Less stuff means less environmental impact!",
          },
          "Green Cleaning": {
            unit: "uses",
            factor: -0.022,
            icon: "fa-spray-can",
            alternatives: ["DIY Cleaners", "Refillable Containers"],
            suggestion:
              "Natural cleaning products are better for you and the environment.",
          },
        },
      };

      // Initialize app
      const app = new EcoTrackData();

      // Modal functionality
      const modal = document.getElementById("logging-modal");
      const logBtn = document.getElementById("log-action-btn");
      const closeBtn = document.getElementById("close-modal");
      const activityForm = document.getElementById("activity-form");

      if (logBtn) {
        logBtn.addEventListener("click", () => {
          modal.classList.add("active");
          resetForm();
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          modal.classList.remove("active");
        });
      }

      if (modal) {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.classList.remove("active");
          }
        });
      }

      document.querySelectorAll(".activity-category").forEach((category) => {
        category.addEventListener("click", () => {
          document
            .querySelectorAll(".activity-category")
            .forEach((c) => c.classList.remove("selected"));
          category.classList.add("selected");
          updateActivityTypes(category.dataset.category);
        });
      });

      function updateActivityTypes(category) {
        const typeSelect = document.getElementById("activity-type");
        const unitSelect = document.getElementById("activity-unit");

        if (!typeSelect) return;

        typeSelect.innerHTML =
          '<option value="">Select an activity...</option>';
        unitSelect.innerHTML = '<option value="">Select unit...</option>';

        const activities = activityData[category] || {};
        Object.keys(activities).forEach((activity) => {
          const option = document.createElement("option");
          option.value = activity;
          option.textContent = activity;
          typeSelect.appendChild(option);
        });
      }

      function updateUnits(activityType, category) {
        const unitSelect = document.getElementById("activity-unit");
        if (!unitSelect) return;

        const activity = activityData[category]?.[activityType];

        if (activity) {
          unitSelect.innerHTML = '<option value="">Select unit...</option>';
          const option = document.createElement("option");
          option.value = activity.unit;
          option.textContent = activity.unit;
          unitSelect.appendChild(option);
        }
      }

      function calculateCarbonImpact(amount, activityType, category) {
        const activity = activityData[category]?.[activityType];
        if (!activity) return 0;

        return amount * activity.factor;
      }

      function updateCarbonImpact() {
        const category = document.querySelector(".activity-category.selected")
          ?.dataset.category;
        const activityType = document.getElementById("activity-type")?.value;
        const amount =
          parseFloat(document.getElementById("activity-amount")?.value) || 0;

        if (category && activityType && amount > 0) {
          const impact = calculateCarbonImpact(amount, activityType, category);
          const activity = activityData[category]?.[activityType];

          const carbonValue = document.getElementById("carbon-value");
          const carbonImpact = document.getElementById("carbon-impact");

          if (carbonValue)
            carbonValue.textContent = (impact * 2.20462).toFixed(2);
          if (carbonImpact) carbonImpact.style.display = "block";

          // Show suggestions
          if (activity) {
            const suggestionText = document.getElementById("suggestion-text");
            const alternativesList =
              document.getElementById("alternatives-list");
            const suggestions = document.getElementById("suggestions");

            if (suggestionText)
              suggestionText.textContent = activity.suggestion;

            // Show alternatives
            if (alternativesList) {
              alternativesList.innerHTML = "";
              activity.alternatives.forEach((alt) => {
                const tag = document.createElement("span");
                tag.className = "alternative-tag";
                tag.textContent = alt;
                alternativesList.appendChild(tag);
              });
            }

            if (suggestions) suggestions.style.display = "block";
          }
        } else {
          const carbonImpact = document.getElementById("carbon-impact");
          const suggestions = document.getElementById("suggestions");
          if (carbonImpact) carbonImpact.style.display = "none";
          if (suggestions) suggestions.style.display = "none";
        }
      }

      const activityTypeSelect = document.getElementById("activity-type");
      if (activityTypeSelect) {
        activityTypeSelect.addEventListener("change", (e) => {
          const category = document.querySelector(".activity-category.selected")
            ?.dataset.category;
          if (category) {
            updateUnits(e.target.value, category);
            updateCarbonImpact();
          }
        });
      }

      const activityAmountInput = document.getElementById("activity-amount");
      if (activityAmountInput) {
        activityAmountInput.addEventListener("input", updateCarbonImpact);
      }

      if (activityForm) {
        activityForm.addEventListener("submit", (e) => {
          e.preventDefault();

          const formData = new FormData(activityForm);
          const category = document.querySelector(".activity-category.selected")
            ?.dataset.category;
          const activityType = formData.get("activityType");
          const amount = parseFloat(formData.get("amount"));
          const unit = formData.get("unit");
          const duration = parseFloat(formData.get("duration")) || 1;
          const notes = formData.get("notes");

          if (!category || !activityType || !amount || !unit) {
            alert("Please fill in all required fields");
            return;
          }

          const carbonImpact = calculateCarbonImpact(
            amount,
            activityType,
            category
          );
          const carbonSaved = carbonImpact < 0 ? Math.abs(carbonImpact) : 0;

          console.log(carbonSaved);

          const activity = {
            category: category,
            activityType: activityType,
            amount: amount,
            unit: unit,
            duration: duration,
            notes: notes,
            carbonImpact: Math.abs(carbonImpact),
            carbonSaved: carbonSaved,
          };

          app.addActivity(activity);
          modal.classList.remove("active");
          resetForm();
        });
      }

      function resetForm() {
        if (activityForm) activityForm.reset();
        document
          .querySelectorAll(".activity-category")
          .forEach((c) => c.classList.remove("selected"));
        const activityType = document.getElementById("activity-type");
        const activityUnit = document.getElementById("activity-unit");
        const carbonImpact = document.getElementById("carbon-impact");
        const suggestions = document.getElementById("suggestions");

        if (activityType)
          activityType.innerHTML =
            '<option value="">Select an activity...</option>';
        if (activityUnit)
          activityUnit.innerHTML = '<option value="">Select unit...</option>';
        if (carbonImpact) carbonImpact.style.display = "none";
        if (suggestions) suggestions.style.display = "none";
      }

      const dailyTips = [
        "Choosing public transportation over driving just once a week can reduce your carbon footprint by about 2,200 lbs per year!",
        "A single tree can absorb up to 48 pounds of CO₂ per year. Plant one today!",
        "LED light bulbs use 75% less energy and last 25 times longer than incandescent bulbs.",
        "Eating one less meat meal per week can reduce your carbon footprint by 1,000 pounds per year.",
        "Unplugging electronics when not in use can save up to 10% on your electricity bill.",
        "A reusable water bottle can save 156 plastic bottles per year from ending up in landfills.",
        "Walking or cycling for short trips can reduce your carbon footprint by 1.1 lbs CO₂ per trip.",
      ];

      // Logout functionality
      const logoutModal = document.getElementById("logout-modal");
      const userProfileBtn = document.querySelector("header .fa-user-circle");
      const closeLogoutBtn = document.getElementById("close-logout-modal");
      const cancelLogoutBtn = document.getElementById("cancel-logout");
      const confirmLogoutBtn = document.getElementById("confirm-logout");

      if (userProfileBtn) {
        userProfileBtn.addEventListener("click", () => {
          logoutModal.classList.add("active");
        });
      }

      if (closeLogoutBtn) {
        closeLogoutBtn.addEventListener("click", () => {
          logoutModal.classList.remove("active");
        });
      }

      if (cancelLogoutBtn) {
        cancelLogoutBtn.addEventListener("click", () => {
          logoutModal.classList.remove("active");
        });
      }

      if (logoutModal) {
        logoutModal.addEventListener("click", (e) => {
          if (e.target === logoutModal) {
            logoutModal.classList.remove("active");
          }
        });
      }

      if (confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener("click", async () => {
          try {
            const response = await fetch(`${BASE_URL}/api/auth/logout`, {
              method: "POST",
              credentials: "include",
            });

            if (response.ok) {
              window.location.href = "/index.html";
            } else {
              console.error("Logout failed");
            }
          } catch (error) {
            console.error("Error during logout:", error);
          }
        });
      }
    </script>
  </body>
</html>
